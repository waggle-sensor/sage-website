"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[630],{4144:(e,n,a)=>{a.d(n,{A:()=>t});const t=a.p+"assets/images/plugin-workflow-9b43ba26e58ea48e2d15dff3b447b842.svg"},28453:(e,n,a)=>{a.d(n,{R:()=>i,x:()=>r});var t=a(96540);const s={},o=t.createContext(s);function i(e){const n=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),t.createElement(o.Provider,{value:n},e.children)}},80193:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>l,contentTitle:()=>r,default:()=>c,frontMatter:()=>i,metadata:()=>t,toc:()=>p});const t=JSON.parse('{"id":"tutorials/edge-apps/creating-an-edge-app","title":"Part 2: Creating an edge app","description":"In part 1, we showed an overview of what edge apps are and how they fit into the Waggle ecosystem. Now, we\'ll dive right in and start writing our very own edge app!","source":"@site/docs/tutorials/edge-apps/2-creating-an-edge-app.md","sourceDirName":"tutorials/edge-apps","slug":"/tutorials/edge-apps/creating-an-edge-app","permalink":"/docs/tutorials/edge-apps/creating-an-edge-app","draft":false,"unlisted":false,"editUrl":"https://github.com/waggle-sensor/sage-website/edit/main/docs/tutorials/edge-apps/2-creating-an-edge-app.md","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"sidebar_position":2},"sidebar":"tutorialSidebar","previous":{"title":"Part 1: Intro to edge apps","permalink":"/docs/tutorials/edge-apps/intro-to-edge-apps"},"next":{"title":"Part 3: Testing an edge app","permalink":"/docs/tutorials/edge-apps/testing-an-edge-app"}}');var s=a(74848),o=a(28453);const i={sidebar_position:2},r="Part 2: Creating an edge app",l={},p=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Development workflow",id:"development-workflow",level:2},{value:"A driving example",id:"a-driving-example",level:2},{value:"Bootstrapping our app from a template",id:"bootstrapping-our-app-from-a-template",level:2},{value:"Installing the dependencies",id:"installing-the-dependencies",level:3},{value:"Accessing a camera",id:"accessing-a-camera",level:3},{value:"Publishing results",id:"publishing-results",level:3},{value:"Viewing run logs",id:"viewing-run-logs",level:3},{value:"Uploading a snapshot",id:"uploading-a-snapshot",level:3},{value:"Tools for analyzing run logs (Optional)",id:"tools-for-analyzing-run-logs-optional",level:3},{value:"Next steps",id:"next-steps",level:2}];function d(e){const n={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"part-2-creating-an-edge-app",children:"Part 2: Creating an edge app"})}),"\n",(0,s.jsxs)(n.p,{children:["In ",(0,s.jsx)(n.a,{href:"intro-to-edge-apps",children:"part 1"}),", we showed an overview of what edge apps are and how they fit into the Waggle ecosystem. Now, we'll dive right in and start writing our very own edge app!"]}),"\n",(0,s.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,s.jsxs)(n.p,{children:["For this part of the tutorial, we'll assume you are developing directly on a laptop or machine with a camera or webcam available. You should have some basic development experience in ",(0,s.jsx)(n.a,{href:"https://www.python.org",children:"Python"})," and with ",(0,s.jsx)(n.a,{href:"https://git-scm.com",children:"git"})," for version control."]}),"\n",(0,s.jsx)(n.h2,{id:"development-workflow",children:"Development workflow"}),"\n",(0,s.jsx)(n.p,{children:"In the next few parts of this tutorial, we'll deep dive into the following app development workflow:"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"App Workflow",src:a(4144).A+"",width:"1740",height:"580"})}),"\n",(0,s.jsxs)(n.p,{children:["First, ",(0,s.jsx)(n.strong,{children:"data and model selection"})," is where you scope the problem and identify a new or existing model for your application. This typically happens ",(0,s.jsx)(n.em,{children:"outside"})," of our ecosystem."]}),"\n",(0,s.jsxs)(n.p,{children:["Second, ",(0,s.jsx)(n.strong,{children:"develop and test"})," is where you begin to integrate your initial code with our ecosystem, test and finally build your application in ",(0,s.jsx)(n.a,{href:"/docs/about/architecture#edge-code-repository-ecr",children:"ECR"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["Finally, ",(0,s.jsx)(n.strong,{children:"deploy and iterate"})," is where you schedule your application for deployment and look at the results."]}),"\n",(0,s.jsx)(n.h2,{id:"a-driving-example",children:"A driving example"}),"\n",(0,s.jsx)(n.p,{children:"In order to illustrate progress through each of these stages, we'll start with a concrete code example and iterate on it over the next few sections."}),"\n",(0,s.jsxs)(n.p,{children:["In practice, ",(0,s.jsx)(n.em,{children:"lots"})," of work goes into the data and model selection step. For now, we'll assume that groundwork has already been done and we've settled on the following code snippit to start with."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'import numpy as np\nimport cv2\n\n\ndef compute_mean_color(image):\n    return np.mean(image, (0, 1)).astype(float)\n\n\ndef main():\n    # read example image from file\n    image = cv2.imread("example.jpg")\n\n    # compute mean color\n    mean_color = compute_mean_color(image)\n\n    # print mean color\n    print(mean_color)\n\n\nif __name__ == "__main__":\n    main()\n'})}),"\n",(0,s.jsx)(n.h2,{id:"bootstrapping-our-app-from-a-template",children:"Bootstrapping our app from a template"}),"\n",(0,s.jsx)(n.p,{children:"We'll start our by using a cookiecutter template to bootstrap our app."}),"\n",(0,s.jsx)(n.p,{children:"First, ensure the latest cookiecutter is installed:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"pip3 install --upgrade cookiecutter\n"})}),"\n",(0,s.jsx)(n.p,{children:"Now, run the following command:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"cookiecutter gh:waggle-sensor/cookiecutter-sage-app\n"})}),"\n",(0,s.jsx)(n.p,{children:"You should be prompted to fill in the following fields:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-txt",children:"  [1/5] name (my-amazing-app-name): my-amazing-app-name\n  [2/5] description (My really amazing app!):\n  [3/5] author (My name):\n  [4/5] version (0.1.0):\n  [5/5] Select kind\n    1 - vision\n    2 - usbserial_sensor\n    3 - minimal\n    4 - tutorial                    <<< use 4 for tutorial\n    Choose from [1/2/3/4] (1): 4\n"})}),"\n",(0,s.jsxs)(n.p,{children:["If this succeeds, a new ",(0,s.jsx)(n.code,{children:"app-tutorial"})," directory will be created with the following files:"]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Name"}),(0,s.jsx)(n.th,{children:"Description"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"main.py"}),(0,s.jsx)(n.td,{children:"Main code"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"requirements.txt"}),(0,s.jsx)(n.td,{children:"Code dependencies"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Dockerfile"}),(0,s.jsx)(n.td,{children:"App build instructions"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"sage.yaml"}),(0,s.jsx)(n.td,{children:"App metadata"})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"installing-the-dependencies",children:"Installing the dependencies"}),"\n",(0,s.jsxs)(n.p,{children:["The first step in preparing our example for the edge is to install ",(0,s.jsx)(n.a,{href:"https://github.com/waggle-sensor/pywaggle",children:"pywaggle"})," in our local development environment."]}),"\n",(0,s.jsx)(n.p,{children:"pywaggle is our Python SDK which provides edge apps access to devices (ex. cameras and microphones) and messaging within a node."}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"Accessing Devices",src:a(94732).A+"",width:"1280",height:"509"})}),"\n",(0,s.jsx)(n.p,{children:"For this tutorial, we'll install the latest version of the requirements included in the template:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"pip3 install --upgrade --requirement requirements.txt\n"})}),"\n",(0,s.jsx)(n.h3,{id:"accessing-a-camera",children:"Accessing a camera"}),"\n",(0,s.jsxs)(n.p,{children:["Now that we have pywaggle, the first change we'll make is to use a camera as input rather than a static image file. We'll use the following ",(0,s.jsx)(n.code,{children:"shapshot()"})," function to take an RGB snapshot from the camera."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'import numpy as np\n\nfrom waggle.data.vision import Camera\n\n\ndef compute_mean_color(image):\n    return np.mean(image, (0, 1)).astype(float)\n\n\ndef main():\n    # open camera and take snapshot\n    with Camera() as camera:\n        snapshot = camera.snapshot()\n\n    # compute mean color\n    mean_color = compute_mean_color(snapshot.data)\n\n    # print mean color\n    print(mean_color)\n\n\nif __name__ == "__main__":\n    main()\n'})}),"\n",(0,s.jsx)(n.p,{children:"Now, we can try this out by running:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"python3 main.py\n"})}),"\n",(0,s.jsx)(n.p,{children:"You should see output like:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-txt",children:"[51.43575738 51.83611871 54.64226671]\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.em,{children:"You're exact numbers may differ as this is computed using your default camera."})}),"\n",(0,s.jsx)(n.h3,{id:"publishing-results",children:"Publishing results"}),"\n",(0,s.jsxs)(n.p,{children:["The next change we'll make is to publish our data to the ",(0,s.jsx)(n.a,{href:"/docs/about/architecture#data-repository-dr",children:"Beehive Data Repository"})," instead of just print it. This will allow it to be sent to a Beehive once it's scheduled on a node."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'import numpy as np\n\nfrom waggle.plugin import Plugin\nfrom waggle.data.vision import Camera\n\n\ndef compute_mean_color(image):\n    return np.mean(image, (0, 1)).astype(float)\n\n\ndef main():\n    with Plugin() as plugin:\n        # open camera and take snapshot\n        with Camera() as camera:\n            snapshot = camera.snapshot()\n\n        # compute mean color\n        mean_color = compute_mean_color(snapshot.data)\n\n        # publish mean color\n        plugin.publish("color.mean.r", mean_color[0], timestamp=snapshot.timestamp)\n        plugin.publish("color.mean.g", mean_color[1], timestamp=snapshot.timestamp)\n        plugin.publish("color.mean.b", mean_color[2], timestamp=snapshot.timestamp)\n\n\nif __name__ == "__main__":\n    main()\n'})}),"\n",(0,s.jsx)(n.p,{children:"Now, we'll run this using:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"python3 main.py\n"})}),"\n",(0,s.jsx)(n.p,{children:"You may notice something... there's no output! Usually, published data is sent to a beehive where it can be viewed later. However, because we're developing locally and have not configured a beehive, the data isn't going anywhere. In the next section, we'll see how we can tap into our published data."}),"\n",(0,s.jsx)(n.h3,{id:"viewing-run-logs",children:"Viewing run logs"}),"\n",(0,s.jsx)(n.p,{children:"In order to make developing and debugging apps easier, pywaggle can write out a log directory as follows:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"export PYWAGGLE_LOG_DIR=test-run\npython3 main.py\n"})}),"\n",(0,s.jsxs)(n.p,{children:["This will create a new directory named ",(0,s.jsx)(n.code,{children:"test-run"})," and will contain a file named ",(0,s.jsx)(n.code,{children:"data.ndjson"})," which contains something like:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{"meta":{},"name":"color.mean.r","timestamp":"2022-08-23T13:38:04.619466000","value":32.67932074652778}\n{"meta":{},"name":"color.mean.g","timestamp":"2022-08-23T13:38:04.619466000","value":19.087491319444446}\n{"meta":{},"name":"color.mean.b","timestamp":"2022-08-23T13:38:04.619466000","value":10.337491319444444}\n'})}),"\n",(0,s.jsxs)(n.p,{children:["If we run ",(0,s.jsx)(n.code,{children:"python3 main.py"})," again, then we'll see new data appended to that file:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{"meta":{},"name":"color.mean.r","timestamp":"2022-08-23T13:38:04.619466000","value":32.67932074652778}\n{"meta":{},"name":"color.mean.g","timestamp":"2022-08-23T13:38:04.619466000","value":19.087491319444446}\n{"meta":{},"name":"color.mean.b","timestamp":"2022-08-23T13:38:04.619466000","value":10.337491319444444}\n{"meta":{},"name":"color.mean.r","timestamp":"2022-08-23T13:38:19.719910000","value":30.90709743923611}\n{"meta":{},"name":"color.mean.g","timestamp":"2022-08-23T13:38:19.719910000","value":16.61302517361111}\n{"meta":{},"name":"color.mean.b","timestamp":"2022-08-23T13:38:19.719910000","value":8.565154079861111}\n'})}),"\n",(0,s.jsx)(n.p,{children:"This provides a convenient way to understand the behavior of an app, particularly one with a more complicated flow."}),"\n",(0,s.jsx)(n.h3,{id:"uploading-a-snapshot",children:"Uploading a snapshot"}),"\n",(0,s.jsx)(n.p,{children:"Finally, the last change we'll make is to upload our snapshots after publishing the mean color."}),"\n",(0,s.jsx)(n.p,{children:"We'll upload every snapshot for demonstration purposes, but you wouldn't want to do this in a real app. Instead, you'd typically upload in response to detecting an event such as an anomalous object or loud noise."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'import numpy as np\n\nfrom waggle.plugin import Plugin\nfrom waggle.data.vision import Camera\n\n\ndef compute_mean_color(image):\n    return np.mean(image, (0, 1)).astype(float)\n\n\ndef main():\n    with Plugin() as plugin:\n        # open camera and take snapshot\n        with Camera() as camera:\n            snapshot = camera.snapshot()\n\n        # compute mean color\n        mean_color = compute_mean_color(snapshot.data)\n\n        # publish mean color\n        plugin.publish("color.mean.r", mean_color[0], timestamp=snapshot.timestamp)\n        plugin.publish("color.mean.g", mean_color[1], timestamp=snapshot.timestamp)\n        plugin.publish("color.mean.b", mean_color[2], timestamp=snapshot.timestamp)\n\n        # save and upload image\n        snapshot.save("snapshot.jpg")\n        plugin.upload_file("snapshot.jpg", timestamp=snapshot.timestamp)\n\n\nif __name__ == "__main__":\n    main()\n'})}),"\n",(0,s.jsx)(n.p,{children:"Let's run our app again using:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"export PYWAGGLE_LOG_DIR=test-run\npython3 main.py\n"})}),"\n",(0,s.jsxs)(n.p,{children:["If you take a look in the ",(0,s.jsx)(n.code,{children:"test-run/uploads"})," directory, you should now see an image."]}),"\n",(0,s.jsxs)(n.p,{children:["Uploads are added to the run log directory using the format ",(0,s.jsx)(n.code,{children:"nstimestamp-filename"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["You should also see a corresponding item in the ",(0,s.jsx)(n.code,{children:"data.ndjson"})," file."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{"meta":{},"name":"color.mean.r","timestamp":"2022-08-23T13:39:34.985679000","value":29.601871744791666}\n{"meta":{},"name":"color.mean.g","timestamp":"2022-08-23T13:39:34.985679000","value":16.004838324652777}\n{"meta":{},"name":"color.mean.b","timestamp":"2022-08-23T13:39:34.985679000","value":8.217218967013888}\n{"meta":{"filename":"snapshot.jpg"},"name":"upload","timestamp":"2022-08-23T13:39:34.985679000","value":"/Users/sean/dev/pw-example/test-run/uploads/1661279974985679000-snapshot.jpg"}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"tools-for-analyzing-run-logs-optional",children:"Tools for analyzing run logs (Optional)"}),"\n",(0,s.jsxs)(n.p,{children:["If you find yourself working with run logs frequently, we recommend the ",(0,s.jsx)(n.a,{href:"https://pypi.org/project/sage-data-client/",children:"Sage data client"})," which provides convenient functionality for loading and doing analysis on the ",(0,s.jsx)(n.code,{children:"data.ndjson"})," file. See the ",(0,s.jsx)(n.a,{href:"https://github.com/sagecontinuum/sage-data-client#load-results-from-file",children:'"Load results from file" example'})," for more info."]}),"\n",(0,s.jsx)(n.h2,{id:"next-steps",children:"Next steps"}),"\n",(0,s.jsx)(n.p,{children:"Congratulations! You've finished preparing our example code for the edge!"}),"\n",(0,s.jsxs)(n.p,{children:["In the ",(0,s.jsx)(n.a,{href:"testing-an-edge-app",children:"part 3"}),", we'll look at how we can build and test our app on a real node!"]})]})}function c(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},94732:(e,n,a)=>{a.d(n,{A:()=>t});const t=a.p+"assets/images/access_to_sensors-862c26d27348053c048f1fdf6babeb77.svg"}}]);